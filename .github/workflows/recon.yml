name: Maximum Recon Collector

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  DOMAIN: "meesho.com"
  MAIN_APP: "https://www.meesho.com/"

jobs:
  recon:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Dependencies
        shell: bash
        run: |
          sudo apt update
          sudo apt install -y curl git unzip jq python3 python3-pip coreutils

      - name: Setup Go Environment
        uses: actions/setup-go@v4
        with:
          go-version: "1.23"

      - name: Install Go-Based Tools
        shell: bash
        run: |
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/owasp-amass/amass/v4/cmd/amass@latest
          go install github.com/tomnomnom/assetfinder@latest
          go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/lc/gau/v2/cmd/gau@latest
          go install github.com/tomnomnom/waybackurls@latest
          go install github.com/lc/subjs@latest
          go install github.com/gwen001/github-subdomains@latest
          go install github.com/PentestPad/subzy@latest
          sudo cp ~/go/bin/* /usr/local/bin/

      - name: Install Python-Based Tools
        shell: bash
        run: |
          pip3 install arjun paramspider linkfinder
          git clone https://github.com/m4ll0k/SecretFinder.git /tmp/SecretFinder 2>/dev/null || true

      - name: Create Output Directory
        shell: bash
        run: |
          RUN_ID=$(date +%F_%H-%M-%S)
          mkdir -p output/$RUN_ID
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      - name: Subfinder Enumeration
        shell: bash
        run: timeout 25m subfinder -d $DOMAIN -all -silent > output/$RUN_ID/subfinder.txt || true

      - name: Amass Passive Enumeration
        shell: bash
        run: timeout 25m amass enum -passive -d $DOMAIN -o output/$RUN_ID/amass.txt || true

      - name: Assetfinder Enumeration
        shell: bash
        run: timeout 15m assetfinder --subs-only $DOMAIN > output/$RUN_ID/assetfinder.txt || true

      - name: GitHub Subdomains Enumeration
        shell: bash
        run: timeout 20m github-subdomains -d $DOMAIN -o output/$RUN_ID/github_subdomains.txt || true

      - name: Subzy Takeover Check
        shell: bash
        run: timeout 20m bash -c "cat output/$RUN_ID/*.txt 2>/dev/null | sort -u | subzy run --targets /dev/stdin > output/$RUN_ID/subzy.txt" || true

      - name: DNSX Resolution
        shell: bash
        run: timeout 15m dnsx -d $DOMAIN -silent > output/$RUN_ID/dnsx.txt || true

      - name: HTTPX Detailed Probing
        shell: bash
        run: timeout 15m bash -c "echo $MAIN_APP | httpx -silent -title -tech-detect -status-code -ip > output/$RUN_ID/httpx.txt" || true

      - name: GAU URL Collection
        shell: bash
        run: timeout 20m gau $DOMAIN > output/$RUN_ID/gau.txt || true

      - name: WaybackURLs Collection
        shell: bash
        run: timeout 20m waybackurls $DOMAIN > output/$RUN_ID/wayback.txt || true

      - name: Katana Crawling
        shell: bash
        run: timeout 30m katana -u $MAIN_APP -depth 3 -silent > output/$RUN_ID/katana.txt || true

      - name: SubJS Collection
        shell: bash
        run: timeout 15m bash -c "echo $MAIN_APP | subjs > output/$RUN_ID/subjs.txt" || true

      - name: LinkFinder Analysis
        shell: bash
        run: timeout 20m bash -c "linkfinder -i $MAIN_APP -o cli > output/$RUN_ID/linkfinder.txt" || true

      - name: SecretFinder Analysis
        shell: bash
        run: timeout 20m bash -c "cat output/$RUN_ID/subjs.txt 2>/dev/null | sort -u | head -20 | while read js_url; do python3 /tmp/SecretFinder/SecretFinder.py -i \$js_url -o cli 2>/dev/null; done > output/$RUN_ID/secretfinder.txt" || true

      - name: Arjun Parameter Discovery
        shell: bash
        run: timeout 15m arjun -u $MAIN_APP --get -oT output/$RUN_ID/arjun.txt || true

      - name: ParamSpider Parameter Discovery
        shell: bash
        run: timeout 20m paramspider -d $DOMAIN --output output/$RUN_ID/paramspider.txt || true

      - name: Nuclei Template Update
        shell: bash
        run: timeout 10m nuclei -update-templates || true

      - name: Nuclei Vulnerability Scan
        shell: bash
        run: timeout 30m bash -c "echo $MAIN_APP | nuclei -t exposures/ -t misconfiguration/ -t cves/ -severity low,medium,high,critical -o output/$RUN_ID/nuclei.txt" || true

      - name: Send Telegram Notification
        if: always()
        shell: bash
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          TOTAL_FILES=$(ls output/$RUN_ID 2>/dev/null | wc -l)
          TOTAL_LINES=$(cat output/$RUN_ID/* 2>/dev/null | wc -l)
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            --data-urlencode "text=Recon completed for ${DOMAIN}
          Folder: output/${RUN_ID}
          Files: ${TOTAL_FILES}
          Lines: ${TOTAL_LINES}" || true

      - name: Commit and Push Results
        if: always()
        shell: bash
        run: |
          git config --global user.name "github-actions[bot]"
          git add output/
          git diff --staged --quiet || git commit -m "Recon Results - $RUN_ID"
          git push || true
