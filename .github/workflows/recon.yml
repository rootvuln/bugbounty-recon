name: Slow Bug Bounty Recon + JS Analysis

on:
  workflow_dispatch:

env:
  DOMAIN: zooplus.com
  MAIN_APP: https://www.zooplus.com/

jobs:
  recon:
    runs-on: ubuntu-latest
    timeout-minutes: 180   # Whole job max runtime (3 hours)

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        timeout-minutes: 10
        run: |
          sudo apt update
          sudo apt install -y curl git unzip jq python3 python3-pip

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.22"

      - name: Cache Go build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-cache
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install tools
        timeout-minutes: 20
        run: |
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/owasp-amass/amass/v4/cmd/amass@latest
          go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/lc/gau/v2/cmd/gau@latest
          go install github.com/tomnomnom/waybackurls@latest
          go install github.com/lc/subjs@latest
          go install github.com/003random/getJS/v2@latest
          go install github.com/Brosck/mantra@latest

          sudo cp ~/go/bin/* /usr/local/bin/

      - name: Install LinkFinder
        timeout-minutes: 5
        run: |
          git clone https://github.com/GerbenJavado/LinkFinder.git
          cd LinkFinder
          pip3 install -r requirements.txt

      - name: Create folders
        run: |
          mkdir -p output diff js_analysis

      # -----------------------------
      # Subdomain Enumeration
      # -----------------------------
      - name: Subdomain Enumeration
        timeout-minutes: 30
        run: |
          timeout 25m subfinder -d "$DOMAIN" -all -silent > output/subfinder.txt || true
          timeout 25m amass enum -passive -d "$DOMAIN" -o output/amass.txt || true
          cat output/subfinder.txt output/amass.txt | sort -u > output/subdomains.txt

      # -----------------------------
      # DNS Resolution
      # -----------------------------
      - name: Resolve Subdomains
        timeout-minutes: 10
        run: |
          timeout 8m dnsx -silent -l output/subdomains.txt -o output/resolved.txt || true

      # -----------------------------
      # Live Hosts
      # -----------------------------
      - name: Live Hosts
        timeout-minutes: 15
        run: |
          timeout 12m httpx -silent -sc -title -tech-detect -rl 2 -threads 5 \
            -l output/resolved.txt \
            -o output/live.txt || true

          awk '{print $1}' output/live.txt | sort -u > output/live_hosts.txt

      # -----------------------------
      # URL Collection
      # -----------------------------
      - name: Collect URLs
        timeout-minutes: 20
        run: |
          timeout 15m gau "$DOMAIN" > output/gau.txt || true
          timeout 15m waybackurls < output/subdomains.txt > output/wayback.txt || true
          cat output/gau.txt output/wayback.txt | sort -u > output/all_urls.txt

      # -----------------------------
      # Katana Crawl
      # -----------------------------
      - name: Crawl Main App
        timeout-minutes: 20
        run: |
          timeout 15m katana -u "$MAIN_APP" -d 4 -rl 1 -c 1 -silent > output/katana.txt || true
          cat output/all_urls.txt output/katana.txt | sort -u > output/final_urls.txt

      # -----------------------------
      # Extract Parameters
      # -----------------------------
      - name: Extract Parameters
        timeout-minutes: 5
        run: |
          grep "=" output/final_urls.txt | sort -u > output/params.txt || true

      # -----------------------------
      # JS Discovery
      # -----------------------------
      - name: JavaScript Discovery
        timeout-minutes: 25
        run: |
          timeout 20m subjs < output/live_hosts.txt > output/js_subjs.txt || true
          timeout 20m getJS --input output/live_hosts.txt --complete --output output/js_getjs.txt || true
          cat output/js_subjs.txt output/js_getjs.txt | sort -u > output/all_js.txt

      # -----------------------------
      # JS Endpoint Extraction
      # -----------------------------
      - name: JS Endpoint Extraction
        timeout-minutes: 25
        run: |
          rm -f js_analysis/linkfinder_endpoints.txt
          touch js_analysis/linkfinder_endpoints.txt

          timeout 20m bash -c '
          while read -r jsurl; do
            python3 LinkFinder/linkfinder.py -i "$jsurl" -o cli >> js_analysis/linkfinder_endpoints.txt || true
          done < output/all_js.txt
          '

          sort -u js_analysis/linkfinder_endpoints.txt > output/js_endpoints.txt

      # -----------------------------
      # Secrets Scan
      # -----------------------------
      - name: Secrets Scan
        timeout-minutes: 15
        run: |
          timeout 12m mantra -l output/all_js.txt -o output/js_secrets.txt -silent -rl 1 || true

      # -----------------------------
      # Nuclei Scan
      # -----------------------------
      - name: Nuclei Scan
        timeout-minutes: 45
        run: |
          timeout 40m nuclei -l output/live_hosts.txt \
            -severity medium,high,critical \
            -tags exposure,misconfig,cves \
            -rl 1 -c 1 \
            -timeout 10 -retries 1 \
            -o output/nuclei_results.txt || true

      # -----------------------------
      # Diff New Findings
      # -----------------------------
      - name: Diff New Findings
        timeout-minutes: 5
        run: |
          touch diff/subdomains_latest.txt diff/urls_latest.txt diff/js_latest.txt diff/secrets_latest.txt

          cp diff/subdomains_latest.txt diff/old_subdomains.txt || true
          cp diff/urls_latest.txt diff/old_urls.txt || true
          cp diff/js_latest.txt diff/old_js.txt || true
          cp diff/secrets_latest.txt diff/old_secrets.txt || true

          cp output/subdomains.txt diff/subdomains_latest.txt
          cp output/final_urls.txt diff/urls_latest.txt
          cp output/all_js.txt diff/js_latest.txt
          cp output/js_secrets.txt diff/secrets_latest.txt

          comm -13 <(sort diff/old_subdomains.txt) <(sort diff/subdomains_latest.txt) > diff/new_subdomains.txt || true
          comm -13 <(sort diff/old_urls.txt) <(sort diff/urls_latest.txt) > diff/new_urls.txt || true
          comm -13 <(sort diff/old_js.txt) <(sort diff/js_latest.txt) > diff/new_js.txt || true
          comm -13 <(sort diff/old_secrets.txt) <(sort diff/secrets_latest.txt) > diff/new_secrets.txt || true

      # -----------------------------
      # Telegram Alert
      # -----------------------------
      - name: Telegram Alert
        if: always()
        timeout-minutes: 5
        run: |
          NEW_SUBS=$(wc -l < diff/new_subdomains.txt)
          NEW_URLS=$(wc -l < diff/new_urls.txt)
          NEW_JS=$(wc -l < diff/new_js.txt)
          NEW_SECRETS=$(wc -l < diff/new_secrets.txt)

          MESSAGE="âœ… Recon Completed for $DOMAIN%0A%0AðŸŒ New Subdomains: $NEW_SUBS%0AðŸ”— New URLs: $NEW_URLS%0AðŸ“œ New JS Files: $NEW_JS%0AðŸ”‘ New Secrets Hits: $NEW_SECRETS%0A%0AðŸ“ Check repo output/ folder."

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE"

      # -----------------------------
      # Commit Results
      # -----------------------------
      - name: Commit Results
        if: always()
        timeout-minutes: 5
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          git add output/ diff/ js_analysis/
          git commit -m "Daily slow recon update" || echo "No changes"
          git push
